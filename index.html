<html>
<head>
<title>test</title>
<style type="text/css">
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
    var TILE_SIZE = 256;
    var Frame;
    var FrameHeight, FrameWidth;
    var TopLeftX, TopLeftY;
    var OriginX, OriginY;
    var Scale;
    var Iterations = 200;
    var MouseDown = false;
    var Type = "m";
    var JuliaX, JuliaY;
    var ZoomLabel;

    function makeSrc(i, j)
    {
        return "/mandelbrot/tile.cgi?" + [
            "x0="+(OriginX+i*Scale),
            "x1="+(OriginX+(i+1)*Scale),
            "y0="+(OriginY+j*Scale),
            "y1="+(OriginY+(j+1)*Scale),
            "w="+TILE_SIZE,
            "h="+TILE_SIZE,
            "t="+Type,
            "c="+JuliaX+","+JuliaY,
            "i="+Iterations,
        ].join("&");
    }

    function redraw()
    {
        for (var j = 0; j < Tiles.length; j++) {
            var a = Tiles[j];
            for (var i = 0; i < a.length; i++) {
                a[i].css({
                    "left": TopLeftX + TILE_SIZE*i,
                    "top": TopLeftY + TILE_SIZE*j,
                    "display": "inline"
                });
                a[i].attr("src", makeSrc(i, j));
            }
        }
        ZoomLabel.innerHTML = 1/Scale + "x";
    }

    function redrawCenter(cx, cy)
    {
        var ox = Math.ceil(FrameWidth/2 / TILE_SIZE);
        var oy = Math.ceil(FrameHeight/2 / TILE_SIZE);
        TopLeftX = FrameWidth/2 - Math.floor((ox + cx/Scale - Math.floor(cx/Scale)) * TILE_SIZE);
        TopLeftY = FrameHeight/2 - Math.floor((oy + cy/Scale - Math.floor(cy/Scale)) * TILE_SIZE);
        OriginX = Math.floor(cx/Scale - ox) * Scale;
        OriginY = Math.floor(cy/Scale - oy) * Scale;
        $("#debug").html("Scale="+Scale+" c="+cx+","+cy+" o="+ox+","+oy+" TopLeft="+TopLeftX+","+TopLeftY+" Origin="+OriginX+","+OriginY);
        redraw();
    }

    function getClickPos(ev)
    {
        var t = ev.currentTarget;
        var x = ev.pageX - $(t).offset().left;
        var y = ev.pageY - $(t).offset().top;
        for (var j in Tiles) {
            var a = Tiles[j];
            for (var i in a) {
                if (t == a[i].get(0)) {
                    return [OriginX + i*Scale + x*Scale/TILE_SIZE,
                            OriginY + j*Scale + y*Scale/TILE_SIZE];
                }
            }
        }
        return null;
    }

    function down(ev)
    {
        ev.preventDefault();
        DragStartX = parseInt(ev.clientX);
        DragStartY = parseInt(ev.clientY);
        MouseDown = true;
        return false;
    }

    function dragstart(ev)
    {
        return false;
    }

    function move(ev)
    {
        if (MouseDown) {
            for (var j = 0; j < Tiles.length; j++) {
                var a = Tiles[j];
                for (var i = 0; i < a.length; i++) {
                    a[i].css({
                        "left": TopLeftX + i * TILE_SIZE + (ev.clientX - DragStartX),
                        "top": TopLeftY + j * TILE_SIZE + (ev.clientY - DragStartY)
                    });
                }
            }
            var leftmost = Tiles[0][0].offset().left;
            var rightmost = Tiles[0][Tiles[0].length-1].offset().left;
            $("#debug").html(TopLeftX);
            if (leftmost > 0) {
                TopLeftX -= TILE_SIZE;
                OriginX -= Scale;
                for (var j = 0; j < Tiles.length; j++) {
                    var t = Tiles[j].pop();
                    Tiles[j].unshift(t);
                    t.css("left", leftmost - TILE_SIZE);
                    t.attr("src", makeSrc(0, j));
                }
            } else if (rightmost+TILE_SIZE < FrameWidth) {
                TopLeftX += TILE_SIZE;
                OriginX += Scale;
                for (var j = 0; j < Tiles.length; j++) {
                    var t = Tiles[j].shift();
                    Tiles[j].push(t);
                    t.css("left", rightmost + TILE_SIZE);
                    t.attr("src", makeSrc(Tiles[0].length-1, j));
                }
            }
            var topmost = Tiles[0][0].offset().top;
            var bottommost = Tiles[Tiles.length-1][0].offset().top;
            if (topmost > 0) {
                TopLeftY -= TILE_SIZE;
                OriginY -= Scale;
                Tiles.unshift(Tiles.pop());
                for (var i = 0; i < Tiles[0].length; i++) {
                    var t = Tiles[0][i];
                    t.css("top", topmost - TILE_SIZE);
                    t.attr("src", makeSrc(i, 0));
                }
            } else if (bottommost+TILE_SIZE < FrameHeight) {
                TopLeftY += TILE_SIZE;
                OriginY += Scale;
                Tiles.push(Tiles.shift());
                for (var i = 0; i < Tiles[0].length; i++) {
                    var t = Tiles[Tiles.length-1][i];
                    t.css("top", bottommost + TILE_SIZE);
                    t.attr("src", makeSrc(i, Tiles.length-1));
                }
            }
        }
    }

    function up(ev)
    {
        if (MouseDown) {
            TopLeftX += (ev.clientX - DragStartX);
            TopLeftY += (ev.clientY - DragStartY);
        }
        MouseDown = false;
    }

    /*function julia(ev)
    {
        if (!ev) ev = window.event;
        if (Type == "j") {
            return zoomin(ev);
        }
        for (var j in Tiles) {
            var a = Tiles[j];
            for (var i in a) {
                if (ev.target == a[i]) {
                    var cx = OriginX + i*Scale + ev.layerX*Scale/TILE_SIZE;
                    var cy = OriginY + j*Scale + ev.layerY*Scale/TILE_SIZE;
                    Type = 'j';
                    JuliaX = cx;
                    JuliaY = cy;
                    Scale = 1;
                    TopLeftX = 0;
                    TopLeftY = 0;
                    OriginX = cx - parseInt(Frame.style.width)/2*Scale/TILE_SIZE;
                    OriginY = cy - parseInt(Frame.style.height)/2*Scale/TILE_SIZE;
                    redraw();
                    return;
                }
            }
        }
    }*/

    function zoomin(ev)
    {
        if (Scale/2 > 0) {
            var c = getClickPos(ev);
            if (c != null) {
                for (j in Tiles) {
                    var a = Tiles[j];
                    for (i in a) {
                        a[i].css("display", "none");
                    }
                }
                Scale /= 2;
                redrawCenter(c[0], c[1]);
            }
        }
    }

    function zoominbutton()
    {
        if (Scale/2 == 0) {
            return;
        }
        for (j in Tiles) {
            var a = Tiles[j];
            for (i in a) {
                a[i].css("display", "none");
            }
        }
        var cx = OriginX + (FrameWidth/2 - TopLeftX) * Scale / TILE_SIZE;
        var cy = OriginY + (FrameHeight/2 - TopLeftY) * Scale / TILE_SIZE;
        Scale /= 2;
        redrawCenter(cx, cy);
    }

    function zoomout()
    {
        if (Scale >= 1) {
            return;
        }
        for (j in Tiles) {
            var a = Tiles[j];
            for (i in a) {
                a[i].css("display", "none");
            }
        }
        var cx = OriginX + (FrameWidth/2 - TopLeftX) * Scale / TILE_SIZE;
        var cy = OriginY + (FrameHeight/2 - TopLeftY) * Scale / TILE_SIZE;
        Scale *= 2;
        redrawCenter(cx, cy);
    }

    function scroll(ev)
    {
        if (!ev) ev = window.event;
        var d = 0;
        if (ev.wheelDelta) {
            d = ev.wheelDelta / 120;
            if (window.opera) {
                d = -d;
            }
        } else if (ev.detail) {
            d = -ev.detail;
        }
        if (d > 0) {
            zoomin(ev);
        } else if (d < 0) {
            zoomout(ev);
        }
        if (ev.preventDefault) {
            ev.preventDefault();
        }
    }

    function detailup()
    {
        Iterations += 100;
        redraw();
    }

    function detaildown()
    {
        if (Iterations > 100) {
            Iterations -= 100;
            redraw();
        }
    }

    $(document).ready(function() {
        Frame = $("#test");
        Frame.css({"overflow": "hidden", "position": "relative"});
        FrameHeight = Frame.height();
        FrameWidth = Frame.width();
        Tiles = [];
        for (var j = 0; j*TILE_SIZE < FrameHeight+TILE_SIZE; j++) {
            var a = [];
            Tiles[Tiles.length] = a;
            for (var i = 0; i*TILE_SIZE < FrameWidth+TILE_SIZE; i++) {
                var t = $(document.createElement("img"));
                t.css({"position": "absolute", "display": "none"});
                t.bind("mousedown", down);
                t.bind("dragstart", dragstart);
                t.bind("mousemove", move);
                t.bind("mouseup", up);
                t.bind("dblclick", zoomin);
                //if (t.addEventListener) {
                //    t.addEventListener("DOMMouseScroll", scroll, false);
                //}
                //t.onmousewheel = scroll;
                Frame.append(t);
                a[a.length] = t;
            }
        }
        function addbutton(left, top, onclick, url) {
            var x = $(document.createElement("div"));
            x.css({
                "position": "absolute",
                "left": left,
                "top": top,
                "cursor": "pointer"
            });
            x.bind("click", onclick);
            x.html("<img src=\""+url+"\">");
            Frame.append(x);
        }
        function addlabel(left, top, text) {
            var x = $(document.createElement("div"));
            x.css({
                "position": "absolute",
                "left": left,
                "top": top,
                "width": 60,
                "color": "white",
                "textAlign": "center"
            });
            x.html(text);
            Frame.append(x);
            return x;
        }
        addbutton(20, 0, "", "pan_up.png");
        addbutton(0, 20, "", "pan_left.png");
        addbutton(40, 20, "", "pan_right.png");
        addbutton(20, 40, "", "pan_down.png");
        addbutton(20, 80, zoominbutton, "zoom_in.png");
        ZoomLabel = addlabel(0, 100, "1x");
        addbutton(20, 120, zoomout, "zoom_out.png");
        addbutton(20, 160, detailup, "detail_more.png");
        addbutton(20, 180, detaildown, "detail_less.png");
        window.onmouseup = up;

        Scale = 1.0;
        redrawCenter(-0.5, 0);
    });
//]]>
</script>
</head>
<body>
<p>moo
<span id="debug"></span>
</p>
<div id="test" style="margin-left: 2em; border: thin black solid; width: 600; height: 520">
</div>
</body>
</html>
